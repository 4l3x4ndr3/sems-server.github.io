<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SEMS: How to set up the proxy for voicemail and voicebox in SEMS</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">SEMS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">How to set up the proxy for voicemail and voicebox in SEMS </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="Introduction"></a>
Introduction</h2>
<p>This text describes how one can set up a SER based home proxy SIP proxy with voicemail and voicebox service implemented in SEMS. </p>
<p>With minor modifications, this should work with home proxies implemented with SER derivatives (<a href="http://kamailio.org">Kamailio</a> 1.x, <a href="http://opensips.org">OpenSIPS</a>), and also with <a href="http://sip-router.org">sip-router</a> (e.g. Kamailio 3.0) based proxy configurations. For other types of proxies or SIP platforms, it should give an idea of what is required to use a SEMS based voicemail system. </p>
<h2><a class="anchor" id="voicemail_in_sems"></a>
Features of a voicemail system with SEMS</h2>
<p>The voicemail system that comes with SEMS supports the following features</p>
<ul>
<li>voicemail2email and/or dial-in voicebox</li>
<li>greeting only mode</li>
<li>voicebox plays message count</li>
<li>new and saved messages</li>
<li>user can record personal greeting message (as a separate service number)</li>
<li>multi-domain capable</li>
<li>multi-language capable (e.g. as user setting), supports single-digits pre and post</li>
<li>supports domain and user aliases (domain/user string or domain-ID (DID)/user-ID (UID) )</li>
<li>prompts per domain/language</li>
<li>default greeting message per domain/language</li>
<li>configurable key bindings for menu </li>
</ul>
<h2><a class="anchor" id="voicemail_parameters"></a>
Parameters to voicemail applications</h2>
<p>Usually, when a call should be sent to the voicemail system, the home proxy already knows some parts or all of the user profile, for example the email address of a user, or the voicemail settings; for example the user profile is already loaded from a DB (or LDAP, RADIUS, DIAMETER etc). For this reason, in a SEMS based voicemail system, the proxy adds the relevant information as parameters to the INVITE request. Those parameters are set in the P-App-Param header.  </p>
<p>Example: </p>
<div class="fragment"><pre class="fragment">
     INVITE sip:1000@sems01.iptel.org:5080 SIP/2.0.                                                                                    
     From: "sayer@iptel" &lt;sip:sayer@iptel.org&gt;;tag=d3olt2dqvl.                                                                      
     To: &lt;sip:1000@iptel.org&gt;.                                                                                                      
     ...
     P-App-Name: voicebox.                                                                                                          
     P-App-Param: usr=sayer;dom=iptel.org;lng=en;uid=3ab0a114-ceff-11da-8607-0002b3abca3a;did=2f2091f5-ceff-11da-8220-0002b338cf3a;.
   </pre></div> <p>If the proxy does not support this, or does not have access to the user profile, there are two solutions:</p>
<ul>
<li>add another SER-based proxy in front of SEMS that has access to user profile, and adds those headers</li>
<li>add the functionality for accessing the user profile to SEMS (e.g. access DB in SEMS)</li>
</ul>
<p>For both solutions, the main complexity lies in the fact that the right user needs to be identified (with support for multi domain, aliases, call forwarding etc). </p>
<h2><a class="anchor" id="voicemail_in_sems"></a>
Features of a voicemail system with SEMS</h2>
<p>There is three applications involved in a voicemail/voicebox system in SEMS: <em>voicemail</em>, <em>voicebox</em> and <em>annrecorder</em>. Voicemail is the application that records a message, and sends the message as email or stores it into the voicebox storage. Voicebox is the application that users can dial into, listen to their messages, delete or save them. Annrecorder is an application that lets users record their personal greeting message. </p>
<p>If only voicemail2email is to be used, the voicemail application alone can be employed. In that case, the mode must be set to voicemail (see voicemail application parameters below). </p>
<h2><a class="anchor" id="msg_Storage"></a>
Storage for voice message files and greetings</h2>
<p>The storage for voice messages is implemented in a separate module. This way for example a specialized adapter to some replicated storage system can be implemented and loaded without changing the other applications.  </p>
<p>A storage module only needs to support a few very simple functions: Create, get and delete messages, mark a message as read, list a user's directory, and get the number of messages in the user's directory. The sender and the message record time is encoded in the message name.  </p>
<p>The default storage module, msg_storage, is an implementation that just uses the normal file system calls (fopen(), readdir(), opendir() etc). As 'saved' flag, the mtime of the file is compared to the atime. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>If your file system does not support atime, this will not work, i.e. all messages will always appear as unread! </dd></dl>
<h2><a class="anchor" id="did_uid"></a>
Domain/User text or domain ID (DID) and user ID (UID)</h2>
<p>If the platform supports user and domain aliases (e.g. sip.iptel.org and iptel.org, or numeric aliases), there may not be a canonical user name available. For that case, the user ID and domain ID (canonical user/domain ID) may be used, by setting UID/DID application parameters. This overrides the user name and domain name, so that the correct user and domain is identified. </p>
<h2><a class="anchor" id="vm_modes"></a>
Voicemail application modes</h2>
<p>The voicemail application has four modes:</p>
<ul>
<li>voicemail : send email (default)</li>
<li>box : leave in voicebox (store in msg_storage)</li>
<li>both : send email and leave in voicebox</li>
<li>ann : just play greeting, don't record message.</li>
</ul>
<p>For <em>voicemail</em> and <em>both</em> mode, the email address must be given as parameter. </p>
<h2><a class="anchor" id="vm_avps"></a>
Voicemail specific AVPs</h2>
<p>The following user AVPs should be configured in SerWeb to be user-configurable:</p>
<ul>
<li>voicemail : voicemail mode - 'voicemail', 'box', 'both', or 'ann'</li>
<li>email: email address</li>
<li>lang: language - selectable from those for which prompts are present</li>
</ul>
<h2><a class="anchor" id="ser_commands"></a>
Proxy configuration for ser-oob.cfg</h2>
<p>These route fragments could be inserted into a typical ser-oob or default Kamailio configuration.</p>
<h3><a class="anchor" id="leaving_message"></a>
Leaving a message</h3>
<p>This should be added to native SIP destinations which are not found in usrloc, i.e. instead of replying 480 User temporarily not available, and in FAILURE_ROUTE:</p>
<div class="fragment"><pre class="fragment">
       append_hf("P-App-Name: voicemail\r\n");
       append_hf("P-App-Param: mod=%$t.voicemail%|;eml='%$t.email%|';usr=%@ruri.user%|;snd='%@from.uri%|';dom=%@ruri.host%|;uid=%$t.uid%|;did=%$t.did%|;");
       rewritehostport("voicemail.domain.net:5080");
       route(FORWARD);
   </pre></div><h3><a class="anchor" id="calling_voicebox"></a>
Calling voicebox</h3>
<p>This should be added to SITE-SPECIFIC route: </p>
<div class="fragment"><pre class="fragment">
     if (uri=~"^sip:1000") {               # 1000 is voicebox access number
         append_hf("P-App-Name: voicebox\r\n");
         append_hf("P-App-Param: usr=%@from.uri.user%|;dom=%@from.uri.host%|;lng=%$f.lang%|;uid=%$f.uid%|;did=%$f.did%|;\r\n");
         rewritehostport("voicemail.domain.net:5080");
         route(FORWARD);
     }
   </pre></div><h3><a class="anchor" id="calling_annrecorder"></a>
Recording the greeting</h3>
<p>This is very similar to the one above, and should be added to SITE_SPECIFIC as well: </p>
<div class="fragment"><pre class="fragment">
     if (uri=~"^sip:1001") {               # 1001 is recod greeting number
         append_hf("P-App-Name: annrecorder\r\n");
         append_hf("P-App-Param: usr=%@from.uri.user%|;dom=%@from.uri.host%|;lng=%$f.lang%|;uid=%$f.uid%|;did=%$f.did%|;typ=vm;\r\n");
         rewritehostport("voicemail.domain.net:5080");
         route(FORWARD);
     }
   </pre></div><p> Note the type (typ) here; the annrecorder application can be used to record different greetings (e.g. away greeting when recording message, or normal away greeting). This type can be used when sending a call to <em>voicemail</em> application. </p>
</div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
