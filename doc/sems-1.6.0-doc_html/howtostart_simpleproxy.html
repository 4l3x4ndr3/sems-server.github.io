<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SEMS: How to set up a simple proxy for trying out and using SEMS</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">SEMS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">How to set up a simple proxy for trying out and using SEMS </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="Introduction"></a>
Introduction</h2>
<p>This text describes how one can set up a simple SIP proxy in order to try out services in SEMS.  </p>
<p>We will use the Kamailio 3.0 default proxy installation, and add a route SERVICES which adds the application name, and forwards the call to SEMS. The same configuration can be used with the original SER (iptel.org/ser), sip-router (sip-router.org) or other SER derivatives, like OpenSIPS (opensips.org). </p>
<h2><a class="anchor" id="Installing_Kamailio"></a>
Installing Kamailio</h2>
<p>To install Kamailio 3.0, there is excellent documentation on the <a href="http://www.kamailio.org/dokuwiki/doku.php#setup">Kamailio website</a>. In debain lenny, or for example in Ubuntu 9.10, one can install Kamailio with </p>
<div class="fragment"><pre class="fragment">    $ wget http:<span class="comment">//www.kamailio.org/pub/kamailio/latest/packages/debian-lenny/kamailio_3.0.1_i386.deb</span>
    $ dpkg -i kamailio_3.0.1_i386.deb
</pre></div><p>To activate kamailio, one needs to set <b>RUN_KAMAILIO=yes</b> in <b>/etc/default/kamailio</b>.</p>
<h2><a class="anchor" id="adding_service_route"></a>
Adding a service route</h2>
<p>Kamailio processes all requests according to the logic that is set in the route section of its configuration file, which is a very flexible one. In order to have services executed when some special numebrs are called (e.g. 200 and 300), we add another route to <b>/etc/kamailio/kamailio.cfg</b>: </p>
<div class="fragment"><pre class="fragment">   route[SERVICES] {
        <span class="keywordflow">if</span> ($rU=~<span class="stringliteral">&quot;^200.*&quot;</span>) {
                remove_hf(<span class="stringliteral">&quot;P-App-Name&quot;</span>);
                append_hf(<span class="stringliteral">&quot;P-App-Name: echo\r\n&quot;</span>); 
                $ru = <span class="stringliteral">&quot;sip:&quot;</span> + $rU + <span class="stringliteral">&quot;@&quot;</span> + <span class="stringliteral">&quot;127.0.0.1:5070&quot;</span>;
                route(RELAY);
                exit;
        }
        <span class="keywordflow">if</span> ($rU=~<span class="stringliteral">&quot;^300.*&quot;</span>) {
                remove_hf(<span class="stringliteral">&quot;P-App-Name&quot;</span>);
                append_hf(<span class="stringliteral">&quot;P-App-Name: conference\r\n&quot;</span>); 
                $ru = <span class="stringliteral">&quot;sip:&quot;</span> + $rU + <span class="stringliteral">&quot;@&quot;</span> + <span class="stringliteral">&quot;127.0.0.1:5070&quot;</span>;
                route(RELAY);
                exit;
        }
   }
</pre></div><p>This route block can be added anywhere, for example at the end, or between the PSTN and the SERVICES routes.</p>
<p>Then, in the main route section, which is the one marked with the comment <em># main request routing logic</em>, we call our SERVICES-route, preferably before (or after) the PSTN route: </p>
<div class="fragment"><pre class="fragment">   ...
        <span class="keywordflow">if</span> ($rU==$null) {
<span class="preprocessor">                # request with no Username in RURI</span>
<span class="preprocessor"></span>                sl_send_reply(<span class="stringliteral">&quot;484&quot;</span>,<span class="stringliteral">&quot;Address Incomplete&quot;</span>);
                exit;
        }

        route(SERVICES);

        route(PSTN);

<span class="preprocessor">        # apply DB based aliases (uncomment to enable)</span>
<span class="preprocessor"></span><span class="preprocessor">        ##alias_db_lookup(&quot;dbaliases&quot;);</span>
<span class="preprocessor"></span>
        <span class="keywordflow">if</span> (!lookup(<span class="stringliteral">&quot;location&quot;</span>)) {
   ...
</pre></div><p>Now, if we register a phone to the server, and call the 200 or the 300 number, the INVITE gets sent to 127.0.0.1:5070, with the application that is to be called, added as header to the INVITE.</p>
<h2><a class="anchor" id="setting_up_sems"></a>
Setting up SEMS to select the application</h2>
<p>If we load several applications in SEMS, we can select which application to execute by the P-App-Name header. In <b>sems.conf</b> we set application= so that SEMS looks into the P-App-Name header to determine which application to run: </p>
<div class="fragment"><pre class="fragment">   application=$(apphdr)
   load_plugin=wav;gsm;ilbc;speex;session_timer;conference;echo
   sip_ip=127.0.0.1
   sip_port=5070
   media_ip=some.public.ip.here
</pre></div><dl class="note"><dt><b>Note:</b></dt><dd>in this simple case, we could also have set application= and used regular expression mapping in app_mapping.conf </dd></dl>
</div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
